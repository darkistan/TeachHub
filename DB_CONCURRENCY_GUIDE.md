# üîí –ö–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º—É –¥–æ—Å—Ç—É–ø—É –¥–æ –ë–î

## –ü—Ä–æ–±–ª–µ–º–∞

SQLite –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –±–ª–æ–∫—É—î –≤—Å—é –ë–î –ø—Ä–∏ –∑–∞–ø–∏—Å—ñ, —â–æ –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –ø–æ–º–∏–ª–∫–∏ "database is locked" –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É —Ç–∞ Telegram –±–æ—Ç–∞.

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è (—Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ)

### 1. WAL Mode (Write-Ahead Logging)

**–©–æ —Ü–µ:** –†–µ–∂–∏–º –∂—É—Ä–Ω–∞–ª—é–≤–∞–Ω–Ω—è, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –æ–¥–Ω–æ—á–∞—Å–Ω–µ —á–∏—Ç–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –∑–∞–ø–∏—Å—É.

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ –ß–∏—Ç–∞–Ω–Ω—è –ù–ï –±–ª–æ–∫—É—î –∑–∞–ø–∏—Å
- ‚úÖ –ó–∞–ø–∏—Å –ù–ï –±–ª–æ–∫—É—î —á–∏—Ç–∞–Ω–Ω—è
- ‚úÖ –¢—ñ–ª—å–∫–∏ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ –∑–∞–ø–∏—Å–∏ –±–ª–æ–∫—É—é—Ç—å—Å—è (–∞–ª–µ —Ü–µ —Ä—ñ–¥–∫–æ)
- ‚úÖ –ö—Ä–∞—â–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

**–Ø–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ:**
```python
cursor.execute("PRAGMA journal_mode=WAL")
```

### 2. Busy Timeout (30 —Å–µ–∫—É–Ω–¥)

–Ø–∫—â–æ –ë–î –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞, SQLite –±—É–¥–µ —á–µ–∫–∞—Ç–∏ –¥–æ 30 —Å–µ–∫—É–Ω–¥ –∑–∞–º—ñ—Å—Ç—å –Ω–µ–≥–∞–π–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏.

```python
"timeout": 30  # –≤ connect_args
cursor.execute("PRAGMA busy_timeout=30000")  # –≤ PRAGMA
```

### 3. Retry Logic (3 —Å–ø—Ä–æ–±–∏)

–ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–≤—Ç–æ—Ä—é—î–º–æ –æ–ø–µ—Ä–∞—Ü—ñ—é –∑ exponential backoff:
- 1-–∞ —Å–ø—Ä–æ–±–∞: –æ–¥—Ä–∞–∑—É
- 2-–∞ —Å–ø—Ä–æ–±–∞: —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫—É–Ω–¥–∏
- 3-—è —Å–ø—Ä–æ–±–∞: —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É

**–ö–æ–¥:**
```python
with get_session(max_retries=3) as session:
    # –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –ë–î
```

### 4. Connection Pooling

**–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:**
- `pool_size=10` - 10 –ø–æ—Å—Ç—ñ–π–Ω–∏—Ö –∑'—î–¥–Ω–∞–Ω—å
- `max_overflow=20` - –¥–æ 30 –∑'—î–¥–Ω–∞–Ω—å –≤—Å—å–æ–≥–æ
- `pool_pre_ping=True` - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º
- `pool_recycle=3600` - –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—É –≥–æ–¥–∏–Ω—É

### 5. –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è PRAGMA

```sql
PRAGMA cache_size=10000    -- –ë—ñ–ª—å—à–∏–π –∫–µ—à (10MB)
PRAGMA synchronous=NORMAL  -- –ë–∞–ª–∞–Ω—Å –±–µ–∑–ø–µ–∫–∞/—à–≤–∏–¥–∫—ñ—Å—Ç—å
```

---

## üöÄ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –í Telegram –±–æ—Ç—ñ (async):
```python
from database import get_session
from models import User

# –ü—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ get_session - retry –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
with get_session() as session:
    users = session.query(User).all()
```

### –í Flask –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ:
```python
from database import get_session
from models import ScheduleEntry

@app.route('/schedule')
def schedule():
    # Retry –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—ñ
    with get_session() as session:
        entries = session.query(ScheduleEntry).all()
        return render_template('schedule.html', entries=entries)
```

### –ö–∞—Å—Ç–æ–º–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–±:
```python
# –ö—Ä–∏—Ç–∏—á–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è - –±—ñ–ª—å—à–µ —Å–ø—Ä–æ–±
with get_session(max_retries=5) as session:
    # –í–∞–∂–ª–∏–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è
```

---

## üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ WAL mode:
```bash
sqlite3 schedule_bot.db "PRAGMA journal_mode;"
# –ú–∞—î –≤–∏–≤–µ—Å—Ç–∏: wal
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–ª–æ–∫—É–≤–∞–Ω—å –≤ –ª–æ–≥–∞—Ö:
```python
# –í –ª–æ–≥–∞—Ö —à—É–∫–∞–π—Ç–µ:
grep "–ë–î –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞" logs.txt
```

---

## ‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–Ω—è SQLite

### –ö–æ–ª–∏ SQLite –¥–æ—Å—Ç–∞—Ç–Ω—å–æ:
- ‚úÖ –î–æ 100 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- ‚úÖ –î–æ 1000 –∑–∞–ø–∏—Ç—ñ–≤ –≤ –¥–µ–Ω—å
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
- ‚úÖ –û–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä

### –ö–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω PostgreSQL:
- ‚ùå –ë—ñ–ª—å—à–µ 100 –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- ‚ùå –í–∏—Å–æ–∫–∞ —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø–∏—Å—ñ–≤ (>100/—Å–µ–∫)
- ‚ùå –†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞
- ‚ùå –ö–ª–∞—Å—Ç–µ—Ä —Å–µ—Ä–≤–µ—Ä—ñ–≤

---

## üîß Troubleshooting

### –ü–æ–º–∏–ª–∫–∞ "database is locked"

**–ü—Ä–∏—á–∏–Ω–∏:**
1. –î—É–∂–µ –¥–æ–≤–≥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
2. –ü–æ–º–∏–ª–∫–∞ –≤ –∫–æ–¥—ñ (–Ω–µ –∑–∞–∫—Ä–∏—Ç–∞ —Å–µ—Å—ñ—è)
3. –ó–∞–≤–∏—Å–ª–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è

**–†—ñ—à–µ–Ω–Ω—è:**
```python
# 1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –≤—Å—ñ —Å–µ—Å—ñ—ó –≤ with –±–ª–æ–∫–∞—Ö
with get_session() as session:
    # –ö–æ–¥ —Ç—É—Ç

# 2. –ù–µ —Ç—Ä–∏–º–∞–π—Ç–µ —Å–µ—Å—ñ—é –≤—ñ–¥–∫—Ä–∏—Ç–æ—é –¥–æ–≤–≥–æ
# –ü–û–ì–ê–ù–û:
with get_session() as session:
    data = session.query(Model).all()
    time.sleep(60)  # –°–µ—Å—ñ—è –≤—ñ–¥–∫—Ä–∏—Ç–∞!
    
# –î–û–ë–†–ï:
with get_session() as session:
    data = session.query(Model).all()
# –°–µ—Å—ñ—è –∑–∞–∫—Ä–∏—Ç–∞, –æ–±—Ä–æ–±–ª—è—î–º–æ –¥–∞–Ω—ñ —Ç—É—Ç
process_data(data)

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –±–æ—Ç–∞ —Ç–∞ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
```

### WAL —Ñ–∞–π–ª–∏ (*-wal, *-shm)

**–¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!** WAL mode —Å—Ç–≤–æ—Ä—é—î –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏:
- `schedule_bot.db` - –æ—Å–Ω–æ–≤–Ω–∞ –ë–î
- `schedule_bot.db-wal` - –∂—É—Ä–Ω–∞–ª WAL
- `schedule_bot.db-shm` - shared memory

**–ù–µ –≤–∏–¥–∞–ª—è–π—Ç–µ —ó—Ö –ø—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏!**

### Checkpoint WAL

–î–ª—è –æ—á–∏—â–µ–Ω–Ω—è WAL –∂—É—Ä–Ω–∞–ª—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):
```bash
sqlite3 schedule_bot.db "PRAGMA wal_checkpoint(TRUNCATE);"
```

---

## üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

### Best Practices:

1. **–ö–æ—Ä–æ—Ç–∫—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó:**
```python
# –î–û–ë–†–ï
with get_session() as session:
    user = session.query(User).filter(...).first()
    user.name = "New Name"
# Commit –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

# –ü–û–ì–ê–ù–û
with get_session() as session:
    for i in range(1000):
        # –î–æ–≤–≥–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è –≤ –æ–¥–Ω—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
```

2. **Bulk –æ–ø–µ—Ä–∞—Ü—ñ—ó:**
```python
# –î–ª—è –º–∞—Å–æ–≤–∏—Ö –≤—Å—Ç–∞–≤–æ–∫
with get_session() as session:
    session.bulk_insert_mappings(User, user_list)
```

3. **Read-only –æ–ø–µ—Ä–∞—Ü—ñ—ó:**
```python
# –î–ª—è —á–∏—Ç–∞–Ω–Ω—è –º–æ–∂–Ω–∞ –Ω–µ —Ö–≤–∏–ª—é–≤–∞—Ç–∏—Å—è –ø—Ä–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
with get_session() as session:
    users = session.query(User).all()
# WAL –¥–æ–∑–≤–æ–ª—è—î –æ–¥–Ω–æ—á–∞—Å–Ω–µ —á–∏—Ç–∞–Ω–Ω—è
```

4. **–£–Ω–∏–∫–∞–π—Ç–µ nested —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π:**
```python
# –ü–û–ì–ê–ù–û
with get_session() as session1:
    with get_session() as session2:  # –í–∫–ª–∞–¥–µ–Ω–∞ —Å–µ—Å—ñ—è!
        # –ú–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ deadlock
```

---

## üéØ –í–∏—Å–Ω–æ–≤–æ–∫

–ó –ø–æ—Ç–æ—á–Ω–∏–º–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏:
- ‚úÖ –í–µ–± —Ç–∞ –±–æ—Ç –º–æ–∂—É—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π retry –ø—Ä–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—ñ
- ‚úÖ WAL mode –¥–æ–∑–≤–æ–ª—è—î –ø–∞—Ä–∞–ª–µ–ª—å–Ω–µ —á–∏—Ç–∞–Ω–Ω—è
- ‚úÖ Timeout 30 —Å–µ–∫—É–Ω–¥ –∑–∞–º—ñ—Å—Ç—å –Ω–µ–≥–∞–π–Ω–æ—ó –ø–æ–º–∏–ª–∫–∏

**Schedule Bot –≥–æ—Ç–æ–≤–∏–π –¥–æ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º!** üöÄ



