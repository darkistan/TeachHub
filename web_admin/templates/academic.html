{% extends "base.html" %}
{% block title %}–ê–∫–∞–¥–µ–º—ñ—á–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä - TeachHub Admin{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <h1><i class="bi bi-calendar-range"></i> –ê–∫–∞–¥–µ–º—ñ—á–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä</h1>
        {% if metadata %}
        <p class="text-muted">–ù–∞–∑–≤–∞ –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–ª–∞–¥—É: <strong>{{metadata.group_name}}</strong> | –ù–∞–≤—á–∞–ª—å–Ω–∏–π —Ä—ñ–∫: <strong>{{metadata.academic_year}}</strong></p>
        {% endif %}
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPeriodModal">
            <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –ø–µ—Ä—ñ–æ–¥
        </button>
    </div>
</div>

<!-- –§—ñ–ª—å—Ç—Ä –ø–æ –≤–∏–∫–ª–∞–¥–∞—á—É -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="{{url_for('academic')}}" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">–§—ñ–ª—å—Ç—Ä –ø–æ –≤–∏–∫–ª–∞–¥–∞—á—É:</label>
                        <select name="teacher_id" class="form-select" onchange="this.form.submit()">
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}" {{'selected' if selected_teacher_id == teacher.user_id}}>
                                {{teacher.full_name if teacher.full_name else teacher.username}} ({{teacher.username or teacher.user_id}})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if selected_teacher_id %}
                    <div class="col-md-2">
                        <a href="{{url_for('academic')}}" class="btn btn-secondary mt-4">–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</a>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

{% if not selected_teacher_id %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∞–∫–∞–¥–µ–º—ñ—á–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.
</div>
{% endif %}

<!-- Timeline –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-calendar-check"></i> –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ —Ä–æ–∫—É</h5>
            </div>
            <div class="card-body">
                {% if selected_teacher_id %}
                {% for period in periods %}
                <div class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5>{{period.color}} {{period.name}}</h5>
                            <p class="mb-1">
                                <i class="bi bi-calendar"></i> 
                                {{period.start_date}} - {{period.end_date}} ({{period.weeks}} —Ç–∏–∂–Ω—ñ–≤)
                            </p>
                            <p class="text-muted mb-0"><small>{{period.description}}</small></p>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-warning" onclick="editPeriod({{period.id}}, '{{period.period_id}}', '{{period.name}}', '{{period.start_date}}', '{{period.end_date}}', {{period.weeks}}, '{{period.color}}', '{{period.description}}', {{period.teacher_user_id or 'null'}})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{url_for('delete_academic_period', period_id=period.id)}}" style="display:inline;" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ä—ñ–æ–¥ {{period.name}}?');">
                                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-center text-muted">–ü–µ—Ä—ñ–æ–¥—ñ–≤ –Ω–µ–º–∞—î. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–∏–π –ø–µ—Ä—ñ–æ–¥.</p>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü—è –ø–µ—Ä—ñ–æ–¥—ñ–≤ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-table"></i> –í—Å—ñ –ø–µ—Ä—ñ–æ–¥–∏ ({{periods|length}})</h5>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>–ö–æ–ª—ñ—Ä</th>
                            <th>–ù–∞–∑–≤–∞</th>
                            <th>–í–∏–∫–ª–∞–¥–∞—á</th>
                            <th>–ü–æ—á–∞—Ç–æ–∫</th>
                            <th>–ö—ñ–Ω–µ—Ü—å</th>
                            <th>–¢–∏–∂–Ω—ñ–≤</th>
                            <th>–û–ø–∏—Å</th>
                            <th>–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if selected_teacher_id %}
                        {% for period in periods %}
                        <tr>
                            <td style="font-size:1.5em;">{{period.color}}</td>
                            <td><strong>{{period.name}}</strong></td>
                            <td>{{period.teacher_display}}</td>
                            <td>{{period.start_date}}</td>
                            <td>{{period.end_date}}</td>
                            <td>{{period.weeks}}</td>
                            <td><small>{{period.description[:50]}}{% if period.description|length > 50 %}...{% endif %}</small></td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editPeriod({{period.id}}, '{{period.period_id}}', '{{period.name}}', '{{period.start_date}}', '{{period.end_date}}', {{period.weeks}}, '{{period.color}}', '{{period.description}}', {{period.teacher_user_id or 'null'}})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="POST" action="{{url_for('delete_academic_period', period_id=period.id)}}" style="display:inline;" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ä—ñ–æ–¥?');">
                                    <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="8" class="text-center">–ü–µ—Ä—ñ–æ–¥—ñ–≤ –Ω–µ–º–∞—î</td></tr>
                        {% endfor %}
                        {% else %}
                        <tr><td colspan="8" class="text-center">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –ø–µ—Ä—ñ–æ–¥—ñ–≤</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥—É -->
<div class="modal fade" id="addPeriodModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –∞–∫–∞–¥–µ–º—ñ—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{url_for('add_academic_period')}}">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ID –ø–µ—Ä—ñ–æ–¥—É (–ª–∞—Ç–∏–Ω–∏—Ü–µ—é, –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤)</label>
                        <input type="text" class="form-control" name="period_id" placeholder="theoretical_study_1" required>
                        <small class="text-muted">–ü—Ä–∏–∫–ª–∞–¥: session_1, winter_holidays</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞ –ø–µ—Ä—ñ–æ–¥—É</label>
                        <input type="text" class="form-control" name="name" placeholder="–¢–µ–æ—Ä–µ—Ç–∏—á–Ω–µ –Ω–∞–≤—á–∞–Ω–Ω—è (–æ—Å—ñ–Ω—å)" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–∏–∂–Ω—ñ–≤</label>
                            <input type="number" class="form-control" name="weeks" min="1" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ö–æ–ª—ñ—Ä (emoji)</label>
                            <select class="form-select" name="color">
                                <option value="üü¶">üü¶ –°–∏–Ω—ñ–π (–Ω–∞–≤—á–∞–Ω–Ω—è)</option>
                                <option value="üî¥">üî¥ –ß–µ—Ä–≤–æ–Ω–∏–π (—Å–µ—Å—ñ—è)</option>
                                <option value="üü¢">üü¢ –ó–µ–ª–µ–Ω–∏–π (–∫–∞–Ω—ñ–∫—É–ª–∏)</option>
                                <option value="üîµ">üîµ –ë–ª–∞–∫–∏—Ç–Ω–∏–π (–ø—Ä–∞–∫—Ç–∏–∫–∞)</option>
                                <option value="üü°">üü° –ñ–æ–≤—Ç–∏–π</option>
                                <option value="üü£">üü£ –§—ñ–æ–ª–µ—Ç–æ–≤–∏–π</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á <span class="text-danger">*</span></label>
                        {% if current_user.is_admin %}
                        <select class="form-select" name="teacher_user_id" required>
                            <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}" {{'selected' if selected_teacher_id == teacher.user_id}}>
                                {{teacher.full_name if teacher.full_name else teacher.username}} ({{teacher.username or teacher.user_id}})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">–û–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É</small>
                        {% else %}
                        <input type="hidden" name="teacher_user_id" value="{{current_user.user_id}}">
                        <input type="text" class="form-control" value="{{current_user.full_name}}" disabled>
                        <small class="text-muted">–í–∏ –¥–æ–¥–∞—î—Ç–µ –ø–µ—Ä—ñ–æ–¥ –¥–ª—è —Å–µ–±–µ</small>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥—É -->
<div class="modal fade" id="editPeriodModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–µ—Ä—ñ–æ–¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editPeriodForm">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞ –ø–µ—Ä—ñ–æ–¥—É</label>
                        <input type="text" class="form-control" name="name" id="edit_period_name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
                            <input type="date" class="form-control" name="start_date" id="edit_period_start" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label>
                            <input type="date" class="form-control" name="end_date" id="edit_period_end" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–∏–∂–Ω—ñ–≤</label>
                            <input type="number" class="form-control" name="weeks" id="edit_period_weeks" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–ª—ñ—Ä (emoji)</label>
                        <select class="form-select" name="color" id="edit_period_color">
                            <option value="üü¶">üü¶ –°–∏–Ω—ñ–π (–Ω–∞–≤—á–∞–Ω–Ω—è)</option>
                            <option value="üî¥">üî¥ –ß–µ—Ä–≤–æ–Ω–∏–π (—Å–µ—Å—ñ—è)</option>
                            <option value="üü¢">üü¢ –ó–µ–ª–µ–Ω–∏–π (–∫–∞–Ω—ñ–∫—É–ª–∏)</option>
                            <option value="üîµ">üîµ –ë–ª–∞–∫–∏—Ç–Ω–∏–π (–ø—Ä–∞–∫—Ç–∏–∫–∞)</option>
                            <option value="üü°">üü° –ñ–æ–≤—Ç–∏–π</option>
                            <option value="üü£">üü£ –§—ñ–æ–ª–µ—Ç–æ–≤–∏–π</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å</label>
                        <textarea class="form-control" name="description" id="edit_period_description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á <span class="text-danger">*</span></label>
                        <select class="form-select" name="teacher_user_id" id="edit_period_teacher" required>
                            <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}">
                                {{teacher.full_name if teacher.full_name else teacher.username}} ({{teacher.username or teacher.user_id}})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">–û–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ –¥–ª—è –ø–µ—Ä—ñ–æ–¥—É</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-warning">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editPeriod(id, period_id, name, start, end, weeks, color, description, teacher_user_id) {
    document.getElementById('editPeriodForm').action = '/academic/edit/' + id;
    document.getElementById('edit_period_name').value = name;
    document.getElementById('edit_period_start').value = start;
    document.getElementById('edit_period_end').value = end;
    document.getElementById('edit_period_weeks').value = weeks;
    document.getElementById('edit_period_color').value = color;
    document.getElementById('edit_period_description').value = description;
    if (teacher_user_id) {
        document.getElementById('edit_period_teacher').value = teacher_user_id;
    } else {
        document.getElementById('edit_period_teacher').value = '';
    }
    
    new bootstrap.Modal(document.getElementById('editPeriodModal')).show();
}
</script>
{% endblock %}

