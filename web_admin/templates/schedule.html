{% extends "base.html" %}
{% block title %}–†–æ–∑–∫–ª–∞–¥ - TeachHub Admin{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <h1><i class="bi bi-calendar3"></i> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥–æ–º</h1>
        {% if metadata %}
        <p class="text-muted">–ü–æ—Ç–æ—á–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å: 
            <strong>{{ '–ß–∏—Å–µ–ª—å–Ω–∏–∫' if metadata.current_week == 'numerator' else '–ó–Ω–∞–º–µ–Ω–Ω–∏–∫' }}</strong>
        </p>
        {% endif %}
    </div>
    <div class="col-md-6 text-end">
        <div class="mb-2">
            <label class="form-label me-2">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞:</label>
            <select class="form-select d-inline-block" style="width: auto;" onchange="filterByTeacher(this.value)" required>
                <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                {% for teacher in teachers %}
                <option value="{{teacher.user_id}}" {% if selected_teacher_id == teacher.user_id %}selected{% endif %}>
                    {% if teacher.full_name %}
                        {{teacher.full_name}} (@{{teacher.username}})
                    {% else %}
                        @{{teacher.username}}
                    {% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLessonModal">
            <i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è
        </button>
    </div>
</div>

{% if selected_teacher_id %}
<!-- Tabs –¥–ª—è –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è -->
<ul class="nav nav-tabs" role="tablist">
    {% for day in days_order %}
    <li class="nav-item">
        <button class="nav-link {% if loop.first %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#day-{{day}}" type="button">
            {{ day_names[day] }}
        </button>
    </li>
    {% endfor %}
</ul>

<div class="tab-content mt-3">
    {% for day in days_order %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="day-{{day}}">
        
        <!-- –ß–∏—Å–µ–ª—å–Ω–∏–∫ -->
        <h4 class="mt-3">üìö –ß–∏—Å–µ–ª—å–Ω–∏–∫</h4>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>–ß–∞—Å</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–¢–∏–ø</th>
                        <th>–í–∏–∫–ª–∞–¥–∞—á</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>Google Meet</th>
                        <th>–ö–æ–Ω—Ç—Ä–æ–ª—å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in schedule[day]['numerator'] %}
                    <tr>
                        <td><strong>{{entry.time}}</strong></td>
                        <td>{{entry.subject}}</td>
                        <td><span class="badge bg-info">{{entry.lesson_type}}</span></td>
                        <td>{{entry.teacher_display if entry.teacher_display else entry.teacher}}</td>
                        <td><small>{{entry.teacher_phone}}</small></td>
                        <td>
                            {% if entry.conference_link %}
                            <a href="{{entry.conference_link}}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-camera-video"></i>
                            </a>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-secondary">{{entry.exam_type}}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editLesson({{entry.id}}, '{{entry.day_of_week}}', '{{entry.time}}', '{{entry.subject}}', '{{entry.lesson_type}}', {{entry.teacher_user_id or 'null'}}, '{{entry.teacher_phone}}', '{{entry.classroom}}', '{{entry.conference_link}}', '{{entry.exam_type}}', '{{entry.week_type}}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{url_for('delete_schedule_entry', entry_id=entry.id)}}" style="display:inline;" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è {{entry.subject}}?');">
                                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="8" class="text-center text-muted">–ó–∞–Ω—è—Ç—å –Ω–µ–º–∞—î</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ó–Ω–∞–º–µ–Ω–Ω–∏–∫ -->
        <h4 class="mt-4">üìñ –ó–Ω–∞–º–µ–Ω–Ω–∏–∫</h4>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>–ß–∞—Å</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–¢–∏–ø</th>
                        <th>–í–∏–∫–ª–∞–¥–∞—á</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>Google Meet</th>
                        <th>–ö–æ–Ω—Ç—Ä–æ–ª—å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in schedule[day]['denominator'] %}
                    <tr>
                        <td><strong>{{entry.time}}</strong></td>
                        <td>{{entry.subject}}</td>
                        <td><span class="badge bg-info">{{entry.lesson_type}}</span></td>
                        <td>{{entry.teacher_display if entry.teacher_display else entry.teacher}}</td>
                        <td><small>{{entry.teacher_phone}}</small></td>
                        <td>
                            {% if entry.conference_link %}
                            <a href="{{entry.conference_link}}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-camera-video"></i>
                            </a>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-secondary">{{entry.exam_type}}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editLesson({{entry.id}}, '{{entry.day_of_week}}', '{{entry.time}}', '{{entry.subject}}', '{{entry.lesson_type}}', {{entry.teacher_user_id or 'null'}}, '{{entry.teacher_phone}}', '{{entry.classroom}}', '{{entry.conference_link}}', '{{entry.exam_type}}', '{{entry.week_type}}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{url_for('delete_schedule_entry', entry_id=entry.id)}}" style="display:inline;" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è {{entry.subject}}?');">
                                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="8" class="text-center text-muted">–ó–∞–Ω—è—Ç—å –Ω–µ–º–∞—î</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤–∏–±—ñ—Ä –≤–∏–∫–ª–∞–¥–∞—á–∞ -->
<div class="alert alert-info mt-4">
    <h5><i class="bi bi-info-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</h5>
    <p class="mb-0">–î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ä–æ–∑–∫–ª–∞–¥—É –≤–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ –∑—ñ —Å–ø–∏—Å–∫—É –≤–∏—â–µ.</p>
</div>
{% endif %}

<!-- Modal –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∑–∞–Ω—è—Ç—Ç—è -->
<div class="modal fade" id="addLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{url_for('add_schedule_entry')}}">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–î–µ–Ω—å —Ç–∏–∂–Ω—è</label>
                            <select class="form-select" name="day_of_week" required>
                                {% for day in days_order %}
                                <option value="{{day}}">{{day_names[day]}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">–ß–∞—Å</label>
                            <input type="text" class="form-control" name="time" placeholder="08:30-09:50" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">–¢–∏–ø —Ç–∏–∂–Ω—è</label>
                            <select class="form-select" name="week_type" required>
                                <option value="numerator">–ß–∏—Å–µ–ª—å–Ω–∏–∫</option>
                                <option value="denominator">–ó–Ω–∞–º–µ–Ω–Ω–∏–∫</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
                        <input type="text" class="form-control" name="subject" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                            <select class="form-select" name="lesson_type" required>
                                <option value="–ª–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option>
                                <option value="–ø—Ä–∞–∫—Ç–∏–∫–∞">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                                <option value="–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç—Ä–æ–ª—é</label>
                            <select class="form-select" name="exam_type">
                                <option value="–∑–∞–ª—ñ–∫">–ó–∞–ª—ñ–∫</option>
                                <option value="–µ–∫–∑–∞–º–µ–Ω">–ï–∫–∑–∞–º–µ–Ω</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á</label>
                        <select class="form-select" name="teacher_user_id" id="add_teacher_user_id" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}">
                                {% if teacher.full_name %}
                                    {{teacher.full_name}} (@{{teacher.username}})
                                {% else %}
                                    @{{teacher.username}}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="teacher" id="add_teacher_name" value="">
                        <small class="text-muted">–ü–Ü–ë –≤–∏–∫–ª–∞–¥–∞—á–∞ –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤–∏–∫–ª–∞–¥–∞—á–∞</label>
                            <input type="text" class="form-control" name="teacher_phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label>
                            <input type="text" class="form-control" name="classroom">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Google Meet –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                        <input type="url" class="form-control" name="conference_link" placeholder="https://meet.google.com/...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–Ω—è—Ç—Ç—è -->
<div class="modal fade" id="editLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editLessonForm">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–î–µ–Ω—å —Ç–∏–∂–Ω—è</label>
                            <select class="form-select" name="day_of_week" id="edit_day" required>
                                {% for day in days_order %}
                                <option value="{{day}}">{{day_names[day]}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">–ß–∞—Å</label>
                            <input type="text" class="form-control" name="time" id="edit_time" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">–¢–∏–ø —Ç–∏–∂–Ω—è</label>
                            <select class="form-select" name="week_type" id="edit_week_type" required>
                                <option value="numerator">–ß–∏—Å–µ–ª—å–Ω–∏–∫</option>
                                <option value="denominator">–ó–Ω–∞–º–µ–Ω–Ω–∏–∫</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
                        <input type="text" class="form-control" name="subject" id="edit_subject" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                            <select class="form-select" name="lesson_type" id="edit_lesson_type" required>
                                <option value="–ª–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option>
                                <option value="–ø—Ä–∞–∫—Ç–∏–∫–∞">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                                <option value="–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç—Ä–æ–ª—é</label>
                            <select class="form-select" name="exam_type" id="edit_exam_type">
                                <option value="–∑–∞–ª—ñ–∫">–ó–∞–ª—ñ–∫</option>
                                <option value="–µ–∫–∑–∞–º–µ–Ω">–ï–∫–∑–∞–º–µ–Ω</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á</label>
                        <select class="form-select" name="teacher_user_id" id="edit_teacher_user_id" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}">
                                {% if teacher.full_name %}
                                    {{teacher.full_name}} (@{{teacher.username}})
                                {% else %}
                                    @{{teacher.username}}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="teacher" id="edit_teacher_name" value="">
                        <small class="text-muted">–ü–Ü–ë –≤–∏–∫–ª–∞–¥–∞—á–∞ –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤–∏–∫–ª–∞–¥–∞—á–∞</label>
                            <input type="text" class="form-control" name="teacher_phone" id="edit_teacher_phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label>
                            <input type="text" class="form-control" name="classroom" id="edit_classroom">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Google Meet –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                        <input type="url" class="form-control" name="conference_link" id="edit_conference_link">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-warning">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –î–∞–Ω—ñ –ø—Ä–æ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –¥–ª—è JavaScript
const teachers = {
    {% for teacher in teachers %}
    {{teacher.user_id}}: {
        full_name: '{{teacher.full_name or ''}}',
        username: '{{teacher.username}}'
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function filterByTeacher(teacherId) {
    const url = new URL(window.location);
    if (teacherId) {
        url.searchParams.set('teacher_id', teacherId);
        window.location.href = url.toString();
    } else {
        // –Ø–∫—â–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –≤–∏–∫–ª–∞–¥–∞—á–∞, –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        url.searchParams.delete('teacher_id');
        window.location.href = url.toString();
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ü–Ü–ë –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –≤–∏–∫–ª–∞–¥–∞—á–∞ –≤ —Ñ–æ—Ä–º—ñ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
document.getElementById('add_teacher_user_id')?.addEventListener('change', function() {
    const teacherId = this.value;
    const teacher = teachers[teacherId];
    if (teacher && teacher.full_name) {
        document.getElementById('add_teacher_name').value = teacher.full_name;
    } else if (teacher) {
        document.getElementById('add_teacher_name').value = '@' + teacher.username;
    } else {
        document.getElementById('add_teacher_name').value = '';
    }
});

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ü–Ü–ë –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –≤–∏–∫–ª–∞–¥–∞—á–∞ –≤ —Ñ–æ—Ä–º—ñ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
document.getElementById('edit_teacher_user_id')?.addEventListener('change', function() {
    const teacherId = this.value;
    const teacher = teachers[teacherId];
    if (teacher && teacher.full_name) {
        document.getElementById('edit_teacher_name').value = teacher.full_name;
    } else if (teacher) {
        document.getElementById('edit_teacher_name').value = '@' + teacher.username;
    } else {
        document.getElementById('edit_teacher_name').value = '';
    }
});

function editLesson(id, day, time, subject, type, teacherUserId, phone, classroom, meet, exam, week) {
    document.getElementById('editLessonForm').action = '/schedule/edit/' + id;
    document.getElementById('edit_day').value = day;
    document.getElementById('edit_time').value = time;
    document.getElementById('edit_subject').value = subject;
    document.getElementById('edit_lesson_type').value = type;
    document.getElementById('edit_teacher_user_id').value = teacherUserId || '';
    document.getElementById('edit_teacher_phone').value = phone;
    document.getElementById('edit_classroom').value = classroom;
    document.getElementById('edit_conference_link').value = meet;
    document.getElementById('edit_exam_type').value = exam;
    document.getElementById('edit_week_type').value = week;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –ü–Ü–ë –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º–∏
    if (teacherUserId && teachers[teacherUserId]) {
        const teacher = teachers[teacherUserId];
        document.getElementById('edit_teacher_name').value = teacher.full_name || '@' + teacher.username;
    }
    
    new bootstrap.Modal(document.getElementById('editLessonModal')).show();
}
</script>
{% endblock %}
