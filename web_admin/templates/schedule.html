{% extends "base.html" %}
{% block title %}–†–æ–∑–∫–ª–∞–¥ - TeachHub Admin{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 col-md-6">
        <h1><i class="bi bi-calendar3"></i> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥–æ–º</h1>
        {% if metadata %}
        <p class="text-muted">–ü–æ—Ç–æ—á–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å: 
            <strong>{{ '–ß–∏—Å–µ–ª—å–Ω–∏–∫' if metadata.current_week == 'numerator' else '–ó–Ω–∞–º–µ–Ω–Ω–∏–∫' }}</strong>
        </p>
        {% endif %}
    </div>
    <div class="col-12 col-md-6 text-start text-md-end mt-3 mt-md-0">
        <div class="mb-2">
            <label class="form-label d-block d-md-inline me-2">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞:</label>
            <select class="form-select d-inline-block w-100 w-md-auto" onchange="filterByTeacher(this.value)" required>
                <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ --</option>
                {% for teacher in teachers %}
                <option value="{{teacher.user_id}}" {% if selected_teacher_id == teacher.user_id %}selected{% endif %}>
                    {% if teacher.full_name %}
                        {{teacher.full_name}} (@{{teacher.username}})
                    {% else %}
                        @{{teacher.username}}
                    {% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2 mt-2">
            {% if current_user.is_admin or current_user.can_edit_schedule %}
            <button class="btn btn-primary w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#addLessonModal">
                <i class="bi bi-plus-circle"></i> <span class="d-none d-sm-inline">–î–æ–¥–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</span><span class="d-sm-none">–î–æ–¥–∞—Ç–∏</span>
            </button>
            {% endif %}
            {% if current_user.is_admin %}
            <button class="btn btn-success w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#copyScheduleModal">
                <i class="bi bi-files"></i> <span class="d-none d-sm-inline">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</span><span class="d-sm-none">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</span>
            </button>
            {% endif %}
        </div>
    </div>
</div>

{% if not current_user.is_admin and not current_user.can_edit_schedule %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> <strong>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ</strong><br>
            –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–±–æ—Ä–æ–Ω–∏–≤ –≤–∞–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–Ω—è—Ç—Ç—è. –í–∏ –º–æ–∂–µ—Ç–µ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥.
        </div>
    </div>
</div>
{% endif %}

{% if selected_teacher_id %}
<!-- Tabs –¥–ª—è –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è -->
<ul class="nav nav-tabs" role="tablist">
    {% for day in days_order %}
    <li class="nav-item">
        <button class="nav-link {% if loop.first %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#day-{{day}}" type="button">
            {{ day_names[day] }}
        </button>
    </li>
    {% endfor %}
</ul>

<div class="tab-content mt-3">
    {% for day in days_order %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="day-{{day}}">
        
        <!-- –ß–∏—Å–µ–ª—å–Ω–∏–∫ -->
        <h4 class="mt-3">üìö –ß–∏—Å–µ–ª—å–Ω–∏–∫</h4>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th class="d-none d-md-table-cell">–ß–∞—Å</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th class="d-none d-lg-table-cell">–¢–∏–ø</th>
                        <th class="d-none d-lg-table-cell">–ì—Ä—É–ø–∞</th>
                        <th class="d-none d-xl-table-cell">–í–∏–∫–ª–∞–¥–∞—á</th>
                        <th class="d-none d-xl-table-cell">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th class="d-none d-lg-table-cell">Google Meet</th>
                        <th class="d-none d-xl-table-cell">–ö–æ–Ω—Ç—Ä–æ–ª—å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in schedule[day]['numerator'] %}
                    <tr>
                        <td class="d-none d-md-table-cell"><strong>{{entry.time}}</strong></td>
                        <td>
                            <strong class="d-md-none">{{entry.time}} - </strong>{{entry.subject}}
                            <div class="d-md-none mt-1">
                                <span class="badge bg-info">{{entry.lesson_type}}</span>
                                {% if entry.group_name %}
                                <span class="badge bg-secondary">{{entry.group_name}}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="d-none d-lg-table-cell"><span class="badge bg-info">{{entry.lesson_type}}</span></td>
                        <td class="d-none d-lg-table-cell">
                            {% if entry.group_name %}
                                <span class="badge bg-secondary">{{entry.group_name}}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="d-none d-xl-table-cell">{{entry.teacher_display if entry.teacher_display else entry.teacher}}</td>
                        <td class="d-none d-xl-table-cell"><small>{{entry.teacher_phone}}</small></td>
                        <td class="d-none d-lg-table-cell">
                            {% if entry.conference_link %}
                            <a href="{{entry.conference_link}}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-camera-video"></i>
                            </a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="d-none d-xl-table-cell"><span class="badge bg-secondary">{{entry.exam_type}}</span></td>
                        <td>
                            {% if current_user.is_admin or current_user.can_edit_schedule %}
                            <button class="btn btn-sm btn-warning" onclick="editLesson({{entry.id}}, '{{entry.day_of_week}}', '{{entry.time}}', '{{entry.subject}}', '{{entry.lesson_type}}', {{entry.teacher_user_id or 'null'}}, '{{entry.teacher_phone}}', '{{entry.classroom}}', '{{entry.conference_link}}', '{{entry.exam_type}}', '{{entry.week_type}}', {{entry.group_id or 'null'}})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{url_for('delete_schedule_entry', entry_id=entry.id)}}" style="display:inline;" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è {{entry.subject}}?');">
                                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="2" class="text-center text-muted">–ó–∞–Ω—è—Ç—å –Ω–µ–º–∞—î</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ó–Ω–∞–º–µ–Ω–Ω–∏–∫ -->
        <h4 class="mt-4">üìñ –ó–Ω–∞–º–µ–Ω–Ω–∏–∫</h4>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th class="d-none d-md-table-cell">–ß–∞—Å</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th class="d-none d-lg-table-cell">–¢–∏–ø</th>
                        <th class="d-none d-lg-table-cell">–ì—Ä—É–ø–∞</th>
                        <th class="d-none d-xl-table-cell">–í–∏–∫–ª–∞–¥–∞—á</th>
                        <th class="d-none d-xl-table-cell">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th class="d-none d-lg-table-cell">Google Meet</th>
                        <th class="d-none d-xl-table-cell">–ö–æ–Ω—Ç—Ä–æ–ª—å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in schedule[day]['denominator'] %}
                    <tr>
                        <td class="d-none d-md-table-cell"><strong>{{entry.time}}</strong></td>
                        <td>
                            <strong class="d-md-none">{{entry.time}} - </strong>{{entry.subject}}
                            <div class="d-md-none mt-1">
                                <span class="badge bg-info">{{entry.lesson_type}}</span>
                                {% if entry.group_name %}
                                <span class="badge bg-secondary">{{entry.group_name}}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="d-none d-lg-table-cell"><span class="badge bg-info">{{entry.lesson_type}}</span></td>
                        <td class="d-none d-lg-table-cell">
                            {% if entry.group_name %}
                                <span class="badge bg-secondary">{{entry.group_name}}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="d-none d-xl-table-cell">{{entry.teacher_display if entry.teacher_display else entry.teacher}}</td>
                        <td class="d-none d-xl-table-cell"><small>{{entry.teacher_phone}}</small></td>
                        <td class="d-none d-lg-table-cell">
                            {% if entry.conference_link %}
                            <a href="{{entry.conference_link}}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-camera-video"></i>
                            </a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="d-none d-xl-table-cell"><span class="badge bg-secondary">{{entry.exam_type}}</span></td>
                        <td>
                            {% if current_user.is_admin or current_user.can_edit_schedule %}
                            <button class="btn btn-sm btn-warning" onclick="editLesson({{entry.id}}, '{{entry.day_of_week}}', '{{entry.time}}', '{{entry.subject}}', '{{entry.lesson_type}}', {{entry.teacher_user_id or 'null'}}, '{{entry.teacher_phone}}', '{{entry.classroom}}', '{{entry.conference_link}}', '{{entry.exam_type}}', '{{entry.week_type}}', {{entry.group_id or 'null'}})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="POST" action="{{url_for('delete_schedule_entry', entry_id=entry.id)}}" style="display:inline;" onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è {{entry.subject}}?');">
                                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="2" class="text-center text-muted">–ó–∞–Ω—è—Ç—å –Ω–µ–º–∞—î</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤–∏–±—ñ—Ä –≤–∏–∫–ª–∞–¥–∞—á–∞ -->
<div class="alert alert-info mt-4">
    <h5><i class="bi bi-info-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</h5>
    <p class="mb-0">–î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ä–æ–∑–∫–ª–∞–¥—É –≤–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞ –∑—ñ —Å–ø–∏—Å–∫—É –≤–∏—â–µ.</p>
</div>
{% endif %}

<!-- Modal –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∑–∞–Ω—è—Ç—Ç—è -->
<div class="modal fade" id="addLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{url_for('add_schedule_entry')}}" id="addLessonForm" onsubmit="return validateTimeInput('add')">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–î–µ–Ω—å —Ç–∏–∂–Ω—è <span class="text-danger">***</span></label>
                            <select class="form-select" name="day_of_week" required>
                                {% for day in days_order %}
                                <option value="{{day}}">{{day_names[day]}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø —Ç–∏–∂–Ω—è <span class="text-danger">***</span></label>
                            <select class="form-select" name="week_type" required>
                                <option value="numerator">–ß–∏—Å–µ–ª—å–Ω–∏–∫</option>
                                <option value="denominator">–ó–Ω–∞–º–µ–Ω–Ω–∏–∫</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ß–∞—Å –∑–∞–Ω—è—Ç—Ç—è <span class="text-danger">***</span></label>
                        <div class="row g-2 mb-2">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">–ü–æ—á–∞—Ç–æ–∫</label>
                                <input type="time" class="form-control" id="add_time_start" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted">–ö—ñ–Ω–µ—Ü—å</label>
                                <input type="time" class="form-control" id="add_time_end" required>
                            </div>
                        </div>
                        <input type="hidden" name="time" id="add_time_combined" required>
                        <small class="form-text text-muted">–ê–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É:</small>
                        <select class="form-select mt-2" id="add_time_preset" onchange="setTimeFromPreset('add')">
                            <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Å --</option>
                            <option value="08:30-09:50">08:30-09:50 (1 –ø–∞—Ä–∞)</option>
                            <option value="10:00-11:20">10:00-11:20 (2 –ø–∞—Ä–∞)</option>
                            <option value="12:00-13:20">12:00-13:20 (3 –ø–∞—Ä–∞, –ø—ñ—Å–ª—è –æ–±—ñ–¥—É)</option>
                            <option value="13:30-14:50">13:30-14:50 (4 –ø–∞—Ä–∞)</option>
                            <option value="13:30-14:00">13:30-14:00 (–ì–æ–¥–∏–Ω–∞ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è)</option>
                            <option value="15:00-16:20">15:00-16:20 (5 –ø–∞—Ä–∞)</option>
                            <option value="16:30-17:50">16:30-17:50 (6 –ø–∞—Ä–∞)</option>
                            <option value="18:00-19:20">18:00-19:20 (7 –ø–∞—Ä–∞)</option>
                            <option value="19:30-20:50">19:30-20:50 (8 –ø–∞—Ä–∞)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç <span class="text-danger">***</span></label>
                        <input type="text" class="form-control" name="subject" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è <span class="text-danger">***</span></label>
                            <select class="form-select" name="lesson_type" required>
                                <option value="–ª–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option>
                                <option value="–ø—Ä–∞–∫—Ç–∏–∫–∞">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                                <option value="–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç—Ä–æ–ª—é</label>
                            <select class="form-select" name="exam_type">
                                <option value="–∑–∞–ª—ñ–∫">–ó–∞–ª—ñ–∫</option>
                                <option value="–µ–∫–∑–∞–º–µ–Ω">–ï–∫–∑–∞–º–µ–Ω</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á{% if current_user.is_admin %} <span class="text-danger">***</span>{% endif %}</label>
                        {% if current_user.is_admin %}
                        <select class="form-select" name="teacher_user_id" id="add_teacher_user_id" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}">
                                {% if teacher.full_name %}
                                    {{teacher.full_name}} (@{{teacher.username}})
                                {% else %}
                                    @{{teacher.username}}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="teacher" id="add_teacher_name" value="">
                        <small class="text-muted">–ü–Ü–ë –≤–∏–∫–ª–∞–¥–∞—á–∞ –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</small>
                        {% else %}
                        <input type="hidden" name="teacher_user_id" value="{{current_user.user_id}}">
                        <input type="text" class="form-control" value="{{current_user.full_name or current_user.username}}" disabled>
                        <small class="text-muted">–í–∏ –¥–æ–¥–∞—î—Ç–µ –∑–∞–Ω—è—Ç—Ç—è –¥–ª—è —Å–µ–±–µ</small>
                        {% endif %}
                    </div>
                    <div class="row">
                        {% if current_user.is_admin %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤–∏–∫–ª–∞–¥–∞—á–∞</label>
                            <input type="text" class="form-control" name="teacher_phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label>
                            <input type="text" class="form-control" name="classroom">
                        </div>
                        {% else %}
                        <div class="col-md-12 mb-3">
                            <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label>
                            <input type="text" class="form-control" name="classroom">
                        </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Google Meet –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                        <input type="url" class="form-control" name="conference_link" placeholder="https://meet.google.com/...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ì—Ä—É–ø–∞</label>
                        <select class="form-select" name="group_id">
                            <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ) --</option>
                            {% for group in groups %}
                            <option value="{{group.id}}">{{group.name}}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">–ì—Ä—É–ø–∞, –¥–ª—è —è–∫–æ—ó –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –∑–∞–Ω—è—Ç—Ç—è</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–Ω—è—Ç—Ç—è -->
<div class="modal fade" id="editLessonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editLessonForm" onsubmit="return validateTimeInput('edit')">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–î–µ–Ω—å —Ç–∏–∂–Ω—è <span class="text-danger">***</span></label>
                            <select class="form-select" name="day_of_week" id="edit_day" required>
                                {% for day in days_order %}
                                <option value="{{day}}">{{day_names[day]}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø —Ç–∏–∂–Ω—è <span class="text-danger">***</span></label>
                            <select class="form-select" name="week_type" id="edit_week_type" required>
                                <option value="numerator">–ß–∏—Å–µ–ª—å–Ω–∏–∫</option>
                                <option value="denominator">–ó–Ω–∞–º–µ–Ω–Ω–∏–∫</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ß–∞—Å –∑–∞–Ω—è—Ç—Ç—è <span class="text-danger">***</span></label>
                        <div class="row g-2 mb-2">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">–ü–æ—á–∞—Ç–æ–∫</label>
                                <input type="time" class="form-control" id="edit_time_start" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted">–ö—ñ–Ω–µ—Ü—å</label>
                                <input type="time" class="form-control" id="edit_time_end" required>
                            </div>
                        </div>
                        <input type="hidden" name="time" id="edit_time_combined" required>
                        <small class="form-text text-muted">–ê–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É:</small>
                        <select class="form-select mt-2" id="edit_time_preset" onchange="setTimeFromPreset('edit')">
                            <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Å --</option>
                            <option value="08:30-09:50">08:30-09:50 (1 –ø–∞—Ä–∞)</option>
                            <option value="10:00-11:20">10:00-11:20 (2 –ø–∞—Ä–∞)</option>
                            <option value="12:00-13:20">12:00-13:20 (3 –ø–∞—Ä–∞, –ø—ñ—Å–ª—è –æ–±—ñ–¥—É)</option>
                            <option value="13:30-14:50">13:30-14:50 (4 –ø–∞—Ä–∞)</option>
                            <option value="13:30-14:00">13:30-14:00 (–ì–æ–¥–∏–Ω–∞ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è)</option>
                            <option value="15:00-16:20">15:00-16:20 (5 –ø–∞—Ä–∞)</option>
                            <option value="16:30-17:50">16:30-17:50 (6 –ø–∞—Ä–∞)</option>
                            <option value="18:00-19:20">18:00-19:20 (7 –ø–∞—Ä–∞)</option>
                            <option value="19:30-20:50">19:30-20:50 (8 –ø–∞—Ä–∞)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç <span class="text-danger">***</span></label>
                        <input type="text" class="form-control" name="subject" id="edit_subject" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è <span class="text-danger">***</span></label>
                            <select class="form-select" name="lesson_type" id="edit_lesson_type" required>
                                <option value="–ª–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option>
                                <option value="–ø—Ä–∞–∫—Ç–∏–∫–∞">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                                <option value="–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç—Ä–æ–ª—é</label>
                            <select class="form-select" name="exam_type" id="edit_exam_type">
                                <option value="–∑–∞–ª—ñ–∫">–ó–∞–ª—ñ–∫</option>
                                <option value="–µ–∫–∑–∞–º–µ–Ω">–ï–∫–∑–∞–º–µ–Ω</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á</label>
                        {% if current_user.is_admin %}
                        <select class="form-select" name="teacher_user_id" id="edit_teacher_user_id" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}">
                                {% if teacher.full_name %}
                                    {{teacher.full_name}} (@{{teacher.username}})
                                {% else %}
                                    @{{teacher.username}}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="teacher" id="edit_teacher_name" value="">
                        <small class="text-muted">–ü–Ü–ë –≤–∏–∫–ª–∞–¥–∞—á–∞ –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</small>
                        {% else %}
                        <input type="hidden" name="teacher_user_id" id="edit_teacher_user_id" value="{{current_user.user_id}}">
                        <input type="text" class="form-control" value="{{current_user.full_name or current_user.username}}" disabled>
                        <small class="text-muted">–í–∏ —Ä–µ–¥–∞–≥—É—î—Ç–µ –∑–∞–Ω—è—Ç—Ç—è –¥–ª—è —Å–µ–±–µ</small>
                        {% endif %}
                    </div>
                    <div class="row">
                        {% if current_user.is_admin %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤–∏–∫–ª–∞–¥–∞—á–∞</label>
                            <input type="text" class="form-control" name="teacher_phone" id="edit_teacher_phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label>
                            <input type="text" class="form-control" name="classroom" id="edit_classroom">
                        </div>
                        {% else %}
                        <div class="col-md-12 mb-3">
                            <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label>
                            <input type="text" class="form-control" name="classroom" id="edit_classroom">
                        </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Google Meet –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                        <input type="url" class="form-control" name="conference_link" id="edit_conference_link">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ì—Ä—É–ø–∞</label>
                        <select class="form-select" name="group_id" id="edit_group_id">
                            <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ) --</option>
                            {% for group in groups %}
                            <option value="{{group.id}}">{{group.name}}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">–ì—Ä—É–ø–∞, –¥–ª—è —è–∫–æ—ó –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –∑–∞–Ω—è—Ç—Ç—è</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-warning">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É -->
{% if current_user.is_admin %}
<div class="modal fade" id="copyScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-files"></i> –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{url_for('copy_schedule')}}">
                <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–í—ñ–¥ –≤–∏–∫–ª–∞–¥–∞—á–∞ (–¥–∂–µ—Ä–µ–ª–æ):</label>
                        <select class="form-select" name="from_teacher_id" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}">
                                {% if teacher.full_name %}
                                    {{teacher.full_name}} (@{{teacher.username}})
                                {% else %}
                                    @{{teacher.username}}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–î–æ –≤–∏–∫–ª–∞–¥–∞—á–∞ (–ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è):</label>
                        <select class="form-select" name="to_teacher_id" required>
                            <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                            {% for teacher in teachers %}
                            <option value="{{teacher.user_id}}">
                                {% if teacher.full_name %}
                                    {{teacher.full_name}} (@{{teacher.username}})
                                {% else %}
                                    @{{teacher.username}}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="replace_existing" id="replaceSchedule">
                            <label class="form-check-label" for="replaceSchedule">
                                –ó–∞–º—ñ–Ω–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π —Ä–æ–∑–∫–ª–∞–¥ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –≤–∏–∫–ª–∞–¥–∞—á–∞
                            </label>
                        </div>
                        <small class="form-text text-muted">–Ø–∫—â–æ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–æ —ñ—Å–Ω—É—é—á–æ–≥–æ —Ä–æ–∑–∫–ª–∞–¥—É</small>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> –£–≤–∞–≥–∞! –ë—É–¥–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤—Å—ñ –∑–∞–Ω—è—Ç—Ç—è –≤—ñ–¥ –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ –≤–∏–∫–ª–∞–¥–∞—á–∞ –¥–æ —Ü—ñ–ª—å–æ–≤–æ–≥–æ.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-success">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
// –î–∞–Ω—ñ –ø—Ä–æ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –¥–ª—è JavaScript
const teachers = {
    {% for teacher in teachers %}
    {{teacher.user_id}}: {
        full_name: '{{teacher.full_name or ''}}',
        username: '{{teacher.username}}'
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function filterByTeacher(teacherId) {
    const url = new URL(window.location);
    if (teacherId) {
        url.searchParams.set('teacher_id', teacherId);
        window.location.href = url.toString();
    } else {
        // –Ø–∫—â–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –≤–∏–∫–ª–∞–¥–∞—á–∞, –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        url.searchParams.delete('teacher_id');
        window.location.href = url.toString();
    }
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ü–Ü–ë –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –≤–∏–∫–ª–∞–¥–∞—á–∞ –≤ —Ñ–æ—Ä–º—ñ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
document.getElementById('add_teacher_user_id')?.addEventListener('change', function() {
    const teacherId = this.value;
    const teacher = teachers[teacherId];
    if (teacher && teacher.full_name) {
        document.getElementById('add_teacher_name').value = teacher.full_name;
    } else if (teacher) {
        document.getElementById('add_teacher_name').value = '@' + teacher.username;
    } else {
        document.getElementById('add_teacher_name').value = '';
    }
});

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ü–Ü–ë –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –≤–∏–∫–ª–∞–¥–∞—á–∞ –≤ —Ñ–æ—Ä–º—ñ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
document.getElementById('edit_teacher_user_id')?.addEventListener('change', function() {
    const teacherId = this.value;
    const teacher = teachers[teacherId];
    if (teacher && teacher.full_name) {
        document.getElementById('edit_teacher_name').value = teacher.full_name;
    } else if (teacher) {
        document.getElementById('edit_teacher_name').value = '@' + teacher.username;
    } else {
        document.getElementById('edit_teacher_name').value = '';
    }
});

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–±'—î–¥–Ω–∞–Ω–Ω—è –¥–≤–æ—Ö time picker'—ñ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç "HH:MM-HH:MM"
function combineTimeInputs(prefix) {
    const start = document.getElementById(prefix + '_time_start').value;
    const end = document.getElementById(prefix + '_time_end').value;
    if (start && end) {
        document.getElementById(prefix + '_time_combined').value = start + '-' + end;
        // –°–∫–∏–¥–∞—î–º–æ preset, —è–∫—â–æ —á–∞—Å –≤–≤–µ–¥–µ–Ω–æ –≤—Ä—É—á–Ω—É
        document.getElementById(prefix + '_time_preset').value = '';
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Å—É –∑ preset dropdown
function setTimeFromPreset(prefix) {
    const preset = document.getElementById(prefix + '_time_preset').value;
    if (preset) {
        const [start, end] = preset.split('-');
        document.getElementById(prefix + '_time_start').value = start;
        document.getElementById(prefix + '_time_end').value = end;
        document.getElementById(prefix + '_time_combined').value = preset;
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É —á–∞—Å—É —Ñ–æ—Ä–º–∞—Ç—É "HH:MM-HH:MM" –≤ –¥–≤–∞ time picker'–∏
function parseTimeToInputs(prefix, timeStr) {
    if (timeStr && timeStr.includes('-')) {
        const [start, end] = timeStr.split('-');
        document.getElementById(prefix + '_time_start').value = start;
        document.getElementById(prefix + '_time_end').value = end;
        document.getElementById(prefix + '_time_combined').value = timeStr;
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ preset, —è–∫—â–æ –≤—ñ–Ω –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î
        const preset = document.getElementById(prefix + '_time_preset');
        for (let option of preset.options) {
            if (option.value === timeStr) {
                preset.value = timeStr;
                break;
            }
        }
    }
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —á–∞—Å—É –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é —Ñ–æ—Ä–º–∏
function validateTimeInput(prefix) {
    const start = document.getElementById(prefix + '_time_start').value;
    const end = document.getElementById(prefix + '_time_end').value;
    const combined = document.getElementById(prefix + '_time_combined');
    
    if (!start || !end) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∞—Å –ø–æ—á–∞—Ç–∫—É —Ç–∞ –∫—ñ–Ω—Ü—è –∑–∞–Ω—è—Ç—Ç—è!');
        return false;
    }
    
    if (start >= end) {
        alert('–ß–∞—Å –ø–æ—á–∞—Ç–∫—É –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —Ä–∞–Ω—ñ—à–µ –∑–∞ —á–∞—Å –∫—ñ–Ω—Ü—è!');
        return false;
    }
    
    // –û–±'—î–¥–Ω—É—î–º–æ —á–∞—Å –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é
    combined.value = start + '-' + end;
    return true;
}

// –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è time picker'—ñ–≤ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
document.getElementById('add_time_start')?.addEventListener('change', function() {
    combineTimeInputs('add');
});
document.getElementById('add_time_end')?.addEventListener('change', function() {
    combineTimeInputs('add');
});

// –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è time picker'—ñ–≤ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
document.getElementById('edit_time_start')?.addEventListener('change', function() {
    combineTimeInputs('edit');
});
document.getElementById('edit_time_end')?.addEventListener('change', function() {
    combineTimeInputs('edit');
});

function editLesson(id, day, time, subject, type, teacherUserId, phone, classroom, meet, exam, week, groupId) {
    document.getElementById('editLessonForm').action = '/schedule/edit/' + id;
    document.getElementById('edit_day').value = day;
    parseTimeToInputs('edit', time); // –ü–∞—Ä—Å–∏–º–æ —á–∞—Å –≤ time picker'–∏
    document.getElementById('edit_subject').value = subject;
    document.getElementById('edit_lesson_type').value = type;
    
    // –ü–æ–ª–µ –≤–∏–∫–ª–∞–¥–∞—á–∞ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤
    const teacherSelect = document.getElementById('edit_teacher_user_id');
    if (teacherSelect && teacherSelect.tagName === 'SELECT') {
        teacherSelect.value = teacherUserId || '';
        // –û–Ω–æ–≤–ª—é—î–º–æ –ü–Ü–ë –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º–∏
        if (teacherUserId && teachers[teacherUserId]) {
            const teacher = teachers[teacherUserId];
            const teacherNameInput = document.getElementById('edit_teacher_name');
            if (teacherNameInput) {
                teacherNameInput.value = teacher.full_name || '@' + teacher.username;
            }
        }
    } else {
        // –î–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ - –ø–æ–ª–µ –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ, –∞–ª–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–µ –≤ hidden input
        if (teacherUserId) {
            teacherSelect.value = teacherUserId;
        }
    }
    
    // –¢–µ–ª–µ—Ñ–æ–Ω –≤–∏–∫–ª–∞–¥–∞—á–∞ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤
    const phoneInput = document.getElementById('edit_teacher_phone');
    if (phoneInput) {
        phoneInput.value = phone || '';
    }
    
    document.getElementById('edit_classroom').value = classroom || '';
    document.getElementById('edit_conference_link').value = meet || '';
    document.getElementById('edit_exam_type').value = exam || '–∑–∞–ª—ñ–∫';
    document.getElementById('edit_week_type').value = week;
    document.getElementById('edit_group_id').value = groupId || '';
    
    new bootstrap.Modal(document.getElementById('editLessonModal')).show();
}
</script>
{% endblock %}
