{% extends "base.html" %}

{% block title %}Користувачі - TeachHub Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="bi bi-people"></i> Управління користувачами</h1>
    </div>
</div>

<!-- Запити на доступ -->
{% if pending_requests %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h5><i class="bi bi-clock"></i> Запити на доступ ({{ pending_requests|length }})</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Дата запиту</th>
                            <th>Дії</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in pending_requests %}
                        <tr>
                            <td>{{ req.user_id }}</td>
                            <td>@{{ req.username }}</td>
                            <td>{{ req.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('approve_request', user_id=req.user_id) }}" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="bi bi-check"></i> Схвалити
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('deny_request', user_id=req.user_id) }}" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-x"></i> Відхилити
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Додавання користувача -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-person-plus"></i> Додати користувача</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_user') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="user_id" class="form-label">User ID</label>
                        <input type="number" class="form-control" id="user_id" name="user_id" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" placeholder="username">
                    </div>
                    <div class="mb-3">
                        <label for="full_name" class="form-label">ПІБ викладача</label>
                        <input type="text" class="form-control" id="full_name" name="full_name" placeholder="Іванов Іван Іванович">
                        <small class="text-muted">ПІБ призначається адміністратором</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus"></i> Додати
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Список користувачів -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-list"></i> Користувачі з доступом (<span id="users_count">{{ users|length }}</span>)</h5>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="users_search" placeholder="Пошук по ПІБ, username, ID...">
                </div>
            </div>
            <div class="card-body">
                <table class="table table-hover" id="users_table">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0)">
                                User ID <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(1)">
                                Username <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(2)">
                                ПІБ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(3)">
                                Дата схвалення <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th>Оповіщення</th>
                            <th>Дії</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.user_id }}</td>
                            <td>@{{ user.username }}</td>
                            <td>
                                {% if user.full_name %}
                                    {{ user.full_name }}
                                {% else %}
                                    <span class="text-muted">Не встановлено</span>
                                {% endif %}
                            </td>
                            <td>{{ user.approved_at.strftime('%d.%m.%Y %H:%M') if user.approved_at else '-' }}</td>
                            <td>
                                <form method="POST" action="{{url_for('toggle_notifications', user_id=user.user_id)}}" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{csrf_token()}}"/>
                                    {% if user.notifications_enabled %}
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="bi bi-bell-fill"></i> Увімкнені
                                    </button>
                                    {% else %}
                                    <button type="submit" class="btn btn-sm btn-secondary">
                                        <i class="bi bi-bell-slash"></i> Вимкнені
                                    </button>
                                    {% endif %}
                                </form>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="showEditFullNameModal({{ user.user_id }}, '{{ user.full_name or '' }}', '@{{ user.username }}')">
                                    <i class="bi bi-pencil"></i> Редагувати ПІБ
                                </button>
                                <form method="POST" action="{{ url_for('delete_user', user_id=user.user_id) }}" 
                                      onsubmit="return confirm('Видалити викладача @{{ user.username }}?');" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i> Видалити
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center">Користувачів немає</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальне вікно редагування ПІБ -->
<div class="modal fade" id="editFullNameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редагувати ПІБ викладача</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editFullNameForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <p>Викладач: <strong id="editFullNameUsername"></strong></p>
                    <div class="mb-3">
                        <label for="new_full_name" class="form-label">ПІБ викладача</label>
                        <input type="text" class="form-control" id="new_full_name" name="full_name" placeholder="Іванов Іван Іванович">
                        <small class="text-muted">Залиште порожнім, щоб видалити ПІБ</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                    <button type="submit" class="btn btn-primary">Зберегти</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let sortDirection = {};
    
    function sortTable(columnIndex) {
        const table = document.getElementById('users_table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Визначаємо напрямок сортування
        if (!sortDirection[columnIndex] || sortDirection[columnIndex] === 'desc') {
            sortDirection[columnIndex] = 'asc';
        } else {
            sortDirection[columnIndex] = 'desc';
        }
        
        // Сортуємо рядки
        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].textContent.trim();
            const bText = b.cells[columnIndex].textContent.trim();
            
            // Для числових значень (User ID)
            if (columnIndex === 0) {
                const aNum = parseInt(aText) || 0;
                const bNum = parseInt(bText) || 0;
                return sortDirection[columnIndex] === 'asc' ? aNum - bNum : bNum - aNum;
            }
            
            // Для дат (Дата схвалення)
            if (columnIndex === 3) {
                const aDate = new Date(aText.split('.').reverse().join('-'));
                const bDate = new Date(bText.split('.').reverse().join('-'));
                return sortDirection[columnIndex] === 'asc' ? aDate - bDate : bDate - aDate;
            }
            
            // Для текстових значень
            if (sortDirection[columnIndex] === 'asc') {
                return aText.localeCompare(bText, 'uk');
            } else {
                return bText.localeCompare(aText, 'uk');
            }
        });
        
        // Оновлюємо таблицю
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // Пошук
    document.getElementById('users_search')?.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const table = document.getElementById('users_table');
        const rows = table.querySelectorAll('tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        document.getElementById('users_count').textContent = visibleCount;
    });
    
    function showEditFullNameModal(userId, currentFullName, username) {
        document.getElementById('editFullNameUsername').textContent = username;
        document.getElementById('new_full_name').value = currentFullName || '';
        document.getElementById('editFullNameForm').action = `/users/update-full-name/${userId}`;
        new bootstrap.Modal(document.getElementById('editFullNameModal')).show();
    }
</script>
{% endblock %}



